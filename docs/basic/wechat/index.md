# 微信小程序

## 背景
`JS`是单线程的。`渲染线程` 和 `加载脚本`是互斥的，这也就是为什么长时间的脚本运行可能会导致页面失去响应的原因。
<br/>

![](/wechat/smallapp.png)
> ***在小程序中使用的是`Hybrid`的渲染方式，视图层和逻辑层是分开的，双线程同时运行，视图层使用`WebView`进行渲染，逻辑层运行在`JsCore`中***

+ 渲染层: 界面渲染相关的任务全都在 WebView 线程里执行。一个小程序存在多个界面，所以`渲染层存在多个 WebView 线程`
+ 逻辑层: 采用 JsCore 线程运行 JS 脚本，在这个环境下执行的都是有关小程序业务逻辑的代码

## 通信
### 渲染DOM
小程序在渲染层，宿主环境会把`wxml`转化成对应的`JS`对象,在`逻辑层发生数据变更时`，通过宿主环境提供的`setData`方法`把数据从逻辑层传递到渲染层`，再经过对比前后差异，把差异应用在原来的DOM树上，渲染出正确的视图。
![](/wechat/dom.png)

对于`事件的分发处理`，微信进行了特殊的处理，`将所有的事件拦截后`，丢到逻辑层交给JavaScript进行处理, 即页面更新是异步的，比如在`渲染首屏`的时候，逻辑层与渲染层会同时开始初始化工作，但是渲染层需要有逻辑层的数据才能把界面渲染出来
如果渲染层初始化工作较快完成，就要等逻辑层的指令才能进行下一步工作，
因此逻辑层与渲染层`需要有一定的机制保证时序正确`，在每个小程序页面的生命周期中，存在着若干次页面数据通信
![](/wechat/life.png)


## 运行机制
小程序启动运行有两种情况:
+ 冷启动: 用户首次打开或者小程序被微信主动销毁后再次打开，此时需要重新加载启动
+ 热启动: 用户已经打开过小程序，然后在一定时间内再次打开该小程序，此时无需重新启动，只需要将后台态的小程序切换到前台
> 注意：

> 1.小程序没有重启的概念<br/>
> 2.当小程序进入后台，客户端会维持一段时间的运行状态，超过一定时间后会被微信主动销毁<br/>
> 3.短时间内收到系统两次以上内存警告，也会对小程序进行销毁，这也就为什么一旦页面内存溢出，页面会奔溃的本质原因了<br/>
![](/wechat/reload.png)
开发者在后台发布新版本之后，无法立刻影响到所有现网用户，但最差情况下，也在发布之后 24 小时之内下发新版本信息到用户
<br/>

`每次冷启动时，都会检查是否有更新版本`，如果发现有新版本，将会`异步下载新版本的代码包`，并同时用客户端本地的包进行启动，即`新版本的小程序需要等下一次冷启动才会应用上`

## 小程序与H5
区别如下:
+ **`运行环境`**: 小程序基于浏览器内核重构的内置解析器
+ **`系统权限`**: 小程序能获得更多的系统权限，如网络通信状态、数据缓存能力等
+ **`渲染机制`**: 小程序的逻辑层和渲染层是分开的 

## 优缺点

优点：
+ **`随搜随用，用完即走`**
+ **`流量大，易接受，小程序借助自身平台更容易引入更多流量`**
+ **`安全`**
+ **`开发门槛低`**
+ **`降低浏览器限制`**

缺点:
+ **`用户留存`**: 据有关数据显示，小程序的平均次日留存在13%左右，但是双周留存骤降到仅有1%
+ **`包体积限制`**：微信小程序只有2M的大小，这样导致无法开发大型一些的小程序
+ **`受控微信`**：比起APP，尤其是安卓版的高自由度，小程序要面对很多来自微信的限制，从功能接口，甚至到类别内容，都要接受微信的管控