# 小程序登录
+ 实现小程序用户体系主要涉及到`openid` 和 `code`的概念
+ 调用`wx.login()`方法会生成`code`,将`code`作为参数传递给微信服务器指定接口，就可以获取用户的`openid`
+ 对于每个小程序，微信都会将`用户的微信ID`映射出一个`小程序openid`，作为这个用户在这个小程序的`唯一标识`

![](/wechat/login.png)
- 通过  wx.login()  获取到用户的code判断用户是否授权读取用户信息，调用wx.getUserInfo 读取用户数据
- 由于小程序后台授权域名无法授权微信的域名，所以需要自身后端调用微信服务器获取用户信息
- 通过 wx.request() 方法请求业务方服务器，后端把 appid , appsecret  和 code 一起发送到微信服务器。appid 和 - appsecret 都是微信提供的，可以在管理员后台找到
- 微信服务器返回了 openid 及本次登录的会话密钥 session_key
- 后端从数据库中查找 openid ，如果没有查到记录，说明该用户没有注册，如果有记录，则继续往下走
- session_key 是对用户数据进行加密签名的密钥。为了自身应用安全，session_key 不应该在网络上传输
- 然后生成 session并返回给小程序
- 小程序把 session 存到  storage 里面
- 下次请求时，先从 storage 里面读取，然后带给服务端
- 服务端对比 session 对应的记录，然后校验有效期

更加详细的功能图如下所示：<br/>
![](/wechat/login1.png)

## 扩展

实际业务中，需要校验登录态是否过期

+ 第一种方式: 将本地存储的登录态发送到小程序的服务端，服务端判断为无效登录态时再返回需重新执行登录过程的消息给小程序
+ 第二种方式: 调用`wx.checkSession()`检查微信登录态是否过期,如果过期，发起完整的登录流程，如果不过其，则继续使用本地保存的自定义登录态，好处是不需要小程序服务端参与。

